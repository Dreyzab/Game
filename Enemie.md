АРХИТЕКТУРНАЯ СПЕЦИФИКАЦИЯ: СИСТЕМЫ NPC И БОЕВАЯ ЛОГИКА PROJECT ECHO (СТЕК BUN / ELYSIA / DRIZZLE)КЛАССИФИКАЦИЯ: СИСТЕМНАЯ АРХИТЕКТУРА (SAD) — УРОВЕНЬ 4ПРОЕКТ: «ЭХО ФРАЙБУРГА» (GRENZWANDERER3)ЦЕЛЕВОЙ РЕЛИЗ: ALPHA 0.4 (KINETIC UPDATE)АВТОР: ВЕДУЩИЙ СИСТЕМНЫЙ АРХИТЕКТОРДАТА: 12 ДЕКАБРЯ 20251. Введение и Архитектурная Философия1.1 Кинетический Императив в Проектировании БэкендаТрансформация проекта «Эхо Фрайбурга» из стандартного AR-опыта в глубокий тактический симулятор выживания, очерченная в обновлении «Kinetic Update» (Версия 3.1) 1, диктует необходимость фундаментальной реструктуризации серверной архитектуры. Введение «Кинетического Слоя» — концепции, где каждое действие обладает весом, инерцией и необратимыми психологическими последствиями, — накладывает строжайшие требования к задержке (latency), целостности данных и синхронизации состояний. Переход от изометрических сеток к сценической перспективе «Side-View» с жесткой «Системой Рангов» (1-4) и внедрение режима «Нулевой Дистанции» (Zero-Range) в Районе Анархистов требуют бэкенда, способного обрабатывать сложные мутации состояния на основе тиковой системы (tick-based) в режиме, приближенном к реальному времени.2Для удовлетворения этих требований мы выбрали высокопроизводительный, типобезопасный стек: Bun (Runtime), Elysia (Framework) и Drizzle ORM (Слой взаимодействия с БД) на базе PostgreSQL. Этот выбор обусловлен не только метриками производительности, но и необходимостью строгой валидации сложной бизнес-логики, включающей «Психосоматическое Колодостроение» и вероятностные модели энтропии снаряжения.1.2 Обоснование Технического Стека1.2.1 Bun: Скорость «Момента Щелчка»Геймплейный цикл вводит понятие «Момента Щелчка» (The Click Moment) — доли секунды, когда игрок осознает, что его оружие пусто или заклинило.1 Эта механика, призванная вызвать панику и когнитивную перегрузку, полагается на мгновенную аудиовизуальную обратную связь. Традиционные рантаймы, такие как Node.js, при всей их стабильности, вносят накладные расходы на событийный цикл, которые, будучи пренебрежимо малыми в пошаговых стратегиях, становятся ощутимыми в бою «Нулевой Дистанции», где тайминг является единственным измерением.2Сверхбыстрое время запуска Bun и оптимизированная работа с буферами позволяют нам обрабатывать боевые тики и действия «Прерывания» (Interrupts, основанные на Голосе «Рефлексы») с субмиллисекундными задержками. Это гарантирует, что серверная логика (Server Authority) успевает за клиентским Optimistic UI, предотвращая рассинхронизацию, которая могла бы разрушить иммерсию «тактического отчаяния».3 В условиях, когда выживание игрока зависит от реакции на звук сухого спуска бойка, задержка сети недопустима.1.2.2 Elysia: Типобезопасность и Интеграция WebSocketElysia выбрана за ее сквозную (end-to-end) типобезопасность и превосходную производительность в связке с Bun. Боевая система опирается на «Протокол Троицы» (Protocol Trinity) — синтез Оружия, Артефакта и Голоса.1 Это создает комбинаторный взрыв возможных состояний карт способностей. Использование Elysia в сочетании с TypeScript гарантирует, что каждый объект карты, каждый статус-эффект и каждое вычисление энтропии будут валидированы на этапе компиляции. Это критически снижает вероятность ошибок времени выполнения (runtime errors) во время сложных цепных реакций (например, Толчок -> Удар о Стену -> Оглушение).Более того, нативная поддержка WebSocket в Elysia критически важна для замены механизмов опроса (polling) на постоянные двунаправленные соединения, необходимые для системы одновременных ходов «WeGo», описанной в требованиях к локальному кооперативу.41.2.3 Drizzle ORM + PostgreSQL: Реляционный ХребетВ отличие от документных хранилищ (например, MongoDB), система «Внутреннего Парламента» — где персонаж состоит из 24 различных Голосов, каждый из которых модифицирует различные характеристики и открывает доступ к специфическим механикам, — требует высокоструктурированной реляционной модели.1 Drizzle ORM предоставляет «SQL-подобный» контроль, необходимый для оптимизации сложных запросов (таких как расчет «Уравнения Клина» для тысяч одновременных сессий), сохраняя при этом безопасность типов TypeScript.PostgreSQL обеспечивает транзакционную целостность, необходимую для экономики «Ставок и Долга» на Арене Анархистов.2 Когда игрок ставит на кон свою «Душу» (психическое здоровье) или физические ресурсы, эта транзакция должна соответствовать требованиям ACID, чтобы предотвратить дублирование предметов или потерю критически важных активов в условиях нестабильного мобильного соединения.2. Таксономия NPC и Фракционная АрхитектураАрхитектура неигровых персонажей (NPC) в Project Echo — это не просто набор полосок здоровья и значений атаки. Это цифровое отражение геополитической и психосоциальной реальности Фрайбурга 2040+. Таксономия выводится из анализа «Тактики Зон» 5 и «Атласа Эдема» 6, интегрированных в тактическую реальность игры.2.1 Фракционная МатрицаМы определяем четыре первичных архетипа NPC, каждый из которых требует уникальных схем базы данных и поведенческих деревьев (Behavior Trees). Эти различия не косметические; они диктуют фундаментальные правила взаимодействия с физикой мира и психикой игрока.2.1.1 Фракция: FJR (Freiburg Joint Regiment)Контекст Лора: «Меч Европы», тяжелые механизированные подразделения, базирующиеся в Зоне Гамма.5 Они олицетворяют порядок, высокую технологичность и подавляющую дисциплину.Поведенческая Черта: Осадный Менталитет (Siege Mentality). Юниты FJR отдают приоритет целостности строя (ranks 1-2) и огню на подавление. Они редко действуют в одиночку, предпочитая создавать «стены щитов».Ключевая Механика: Иммунитет к панике «Холодной Стали». Когда у бойца FJR заканчиваются патроны, он не впадает в ступор, а мгновенно переходит к дисциплинированному штыковому бою или использованию приклада, сохраняя боевую эффективность.1Имплементация в БД: Требует отдельной таблицы armor_plating для отслеживания направленного поглощения урона (Фронт против Фланга) и таблицы squad_link для координации баффов защиты.2.1.2 Фракция: Мародеры (Scavengers / Diggers)Контекст Лора: Оппортунистические выжившие из «Индустриального Севера». Используют «Мусорное» оружие (ржавая арматура, осколки стекла), обладающее скрытыми биологическими эффектами.1Поведенческая Черта: Стайный Инстинкт (Pack Instinct). Индивидуально слабые, они получают значительные баффы к агрессии и урону, когда занимают соседние Ранги. Они крайне восприимчивы к Голосу «Авторитет» (Authority) игрока, что позволяет обращать их в бегство без боя.Ключевая Механика: «Столбняк» (Tetanus). Их атаки накладывают нестандартные эффекты периодического урона (DoT), которые скалируются от недостающей выносливости цели, делая затяжные бои смертельными.2Имплементация в БД: Динамические таблицы лута, основанные на «Энтропии» их снаряжения. Оружие Мародера имеет рандомизированное значение condition (0-100), генерируемое при спавне, что влияет на шанс его заклинивания и качество трофея.2.1.3 Фракция: Анархисты (Коллектив Вобан)Контекст Лора: Обитатели автономной Зоны Бета, мастера боя на «Нулевой Дистанции».5Поведенческая Черта: Теория Хаоса (Chaos Theory). Они используют артефакты «Вспышка» и «Стеклянное» оружие (огромный урон, разрушается при ударе). Их тактика — быстрый, дезориентирующий натиск.2Ключевая Механика: «Саботаж» (Sabotage). Анархисты способны манипулировать нагревом (Heat) оружия игрока, принудительно вызывая событие «Клин» (Jam Event).Имплементация в БД: Требуется трекер mental_state (Адреналин/Кураж). В отличие от FJR (использующих MP/Stamina), ресурс Анархистов флуктуирует, позволяя им совершать цепочки действий при успешных атаках.2.1.4 Фракция: Эхо (Мавки / Мариды / Древние)Контекст Лора: Проекции из слоя «Эдем», проявляющиеся у каналов Бэхле (Русалки) или Собора (Мариды/Духи).7Поведенческая Черта: Абиссальная Тишина (Abyssal Silence). Они иммунны к стандартным картам «Блеф» и социальному давлению, но крайне уязвимы к «Ритуальному» урону и «Техно» воздействию (разрыв связи с эфиром).Ключевая Механика: «Гидро-Трансформация». Способны менять форму (Вода/Суша) в зависимости от окружения, изменяя свой хитбокс (Rank Occupation) и доступный набор карт.7Имплементация в БД: Полиморфные таблицы сущностей. NPC типа «Эхо» ссылается на несколько записей stat_block (одна для каждой формы) и переключает current_form_id во время боя.3. Проектирование Схемы Базы Данных (Drizzle ORM)Схема базы данных является скелетом нашей архитектуры. Она должна поддерживать статическое определение NPC (Шаблоны) и их динамические, волатильные состояния во время боя (Инстансы). Мы используем строгую типизацию Drizzle для обеспечения соответствия данных игровой логике.3.1 Таблицы Сущностей (Core Entity Tables)Мы используем PostgreSQL uuid в качестве первичных ключей для предотвращения коллизий при генерации сущностей на распределенных игровых серверах (шардах).TypeScript// db/schema/npcs.ts
import { pgTable, text, integer, uuid, jsonb, boolean, timestamp, check } from 'drizzle-orm/pg-core';
import { sql } from 'drizzle-orm';

// 1. ШАБЛОНЫ NPC (NPC TEMPLATES): "Классовые Определения"
// Определяют базовую статистику и поведение типа врага (напр., "Штурмовик FJR")
// Эти данные неизменяемы и служат основой для спавна.
export const npcTemplates = pgTable('npc_templates', {
  id: uuid('id').defaultRandom().primaryKey(),
  name: text('name').notNull(),
  faction: text('faction', { enum: }).notNull(),
  archetype: text('archetype', { enum: }).notNull(),
  
  // Базовые Атрибуты (Аналог Внутреннего Парламента для NPC)
  // Используются для расчета сопротивлений и эффективности действий
  baseForce: integer('base_force').default(5),      // Сила (Might)
  baseEndurance: integer('base_endurance').default(5), // Выносливость
  baseReflex: integer('base_reflex').default(5),    // Реакция (The Nerve)
  baseLogic: integer('base_logic').default(5),      // Логика
  basePsyche: integer('base_psyche').default(5),    // Психика (Inland Empire)
  baseAuthority: integer('base_authority').default(5), // Авторитет (сопротивление запугиванию)
  
  // Ресурсы
  maxHp: integer('max_hp').notNull(),
  maxStamina: integer('max_stamina').notNull(),
  maxMorale: integer('max_morale').notNull(), // "Воля" к сражению

  // Конфигурация ИИ
  aiBehaviorTreeId: text('ai_behavior_tree_id').notNull(), // Ссылка на JSON-файл логики (GOAP)
  aggroLogic: text('aggro_logic').default('CLOSEST'), // Логика выбора цели: CLOSEST, LOW_HP, HIGH_THREAT

  // Размер и Ранг
  size: integer('size').default(1), // 1 слот, 2 слота (Боссы)
  preferredRank: integer('preferred_rank').notNull(), // Предпочтительная позиция (1-4)

  // Лут и Снаряжение
  lootTableId: uuid('loot_table_id'),
  defaultWeaponId: uuid('default_weapon_id'),
});

// 2. ИНСТАНСЫ NPC (NPC INSTANCES): "Живые" Враги
// Создаются при старте боевой сессии. Эти данные волатильны и изменяются каждый тик.
export const npcInstances = pgTable('npc_instances', {
  id: uuid('id').defaultRandom().primaryKey(),
  templateId: uuid('template_id').references(() => npcTemplates.id),
  combatSessionId: uuid('combat_session_id').notNull(), // Ссылка на активный бой
  
  // Динамическое Состояние
  currentHp: integer('current_hp').notNull(),
  currentStamina: integer('current_stamina').notNull(),
  currentMorale: integer('current_morale').notNull(),
  
  // Позиционирование
  currentRank: integer('current_rank').notNull(), // Текущий ранг (1-4)
  side: text('side').default('ENEMY'), 
  isRooted: boolean('is_rooted').default(false), // Невозможность движения
  isStunned: boolean('is_stunned').default(false), // Пропуск хода
  
  // Статус-Эффекты (Хранятся как JSONB для гибкости и скорости парсинга)
  // Пример: [{"id": "bleed", "stacks": 2, "duration": 3, "sourceId": "player_uuid"}]
  statusEffects: jsonb('status_effects').default(sql`''::jsonb`),
  
  // Состояние Снаряжения (Энтропия)
  // Критически важно для механики "Клина" и лута
  weaponCondition: integer('weapon_condition').default(100), // Износ (0-100)
  weaponHeat: integer('weapon_heat').default(0), // Нагрев (для расчета вероятности клина)
  ammoCount: integer('ammo_count').default(10), // Для логики "Click Moment"
});
3.2 Интеграция Внутреннего ПарламентаХарактеристики игрока — это не простые целые числа; это «Голоса», обладающие субъектностью. Мы отображаем эту сложную взаимосвязь, используя специализированную схему, которая позволяет реализовать «Психосоматическое Колодостроение», описанное в GDD 3.1.1TypeScript// db/schema/attributes.ts

// 18 Голосов (Сила, Болевой Порог, Логика, Эмпатия и т.д.)
// Каждый голос является активным агентом, влияющим на генерацию карт.
export const voiceAttributes = pgTable('voice_attributes', {
  id: uuid('id').defaultRandom().primaryKey(),
  playerId: uuid('player_id').notNull(),
  
  // Группа I: ТЕЛО (Somatic)
  voiceMight: integer('voice_might').default(0),      // "Зверь" (The Beast)
  voicePainThreshold: integer('voice_pain_threshold').default(0), // "Плита" (The Slab)
  voiceEndurance: integer('voice_endurance').default(0),

  // Группа II: МОТОРИКА (Motorics)
  voiceCoordination: integer('voice_coordination').default(0), // Координация Рук/Глаз
  voiceReflexes: integer('voice_reflexes').default(0), // "Нерв" (The Nerve)
  voiceTech: integer('voice_tech').default(0), // "Savoir Faire"

  // Группа III: ПСИХИКА (Psyche)
  voiceAuthority: integer('voice_authority').default(0), // Авторитет
  voiceInlandEmpire: integer('voice_inland_empire').default(0), // Внутренняя Империя
  //... (Остальные голоса)
});

// Правила Синтеза Карт (Card Synthesis Rules)
// Определяет, как конкретный Голос модифицирует карту оружия.
// Это позволяет балансировать систему без изменения кода (Data-Driven Design).
export const cardSynthesisRules = pgTable('card_synthesis_rules', {
  id: uuid('id').defaultRandom().primaryKey(),
  voiceName: text('voice_name').notNull(), // напр., "MIGHT"
  weaponType: text('weapon_type').notNull(), // напр., "BLUNT_HEAVY"
  
  // Модификаторы
  damageMultiplier: integer('damage_multiplier').default(100), // Процентное усиление
  addedEffect: text('added_effect'), // напр., "STAGGER" (Оглушение)
  addedTag: text('added_tag'), // напр., "WALL_SLAM" (Удар о стену)
  apCostModifier: integer('ap_cost_modifier').default(0), // Изменение стоимости действия
});
4. Архитектура Боевой Системы «Protocol Trinity»Ядром «Кинетического Слоя» является «Протокол Троицы» (Protocol Trinity): динамический синтез Оружия (База), Артефакта (Модификатор) и Голоса (Скейлинг). В среде Bun/Elysia это обрабатывается выделенным сервисом CardFactory, который использует функциональную парадигму для композиции объектов карт.4.1 Движок Синтеза Карт (Card Synthesis Engine)Когда начинается бой или игрок берет карту, сервер динамически генерирует объект карты. Это не статический поиск в базе данных, а процедурная генерация. Такой подход позволяет создавать миллионы уникальных комбинаций действий, отражающих текущее психофизическое состояние персонажа.Алгоритм Синтеза:Извлечение Базового Шасси (Fetch Base Chassis): Получение данных об оружии (например, «Glock-19»).Свойства: Базовый урон: 10, Дистанция: 2-4, Стоимость AP: 2.Инъекция Артефакта (Artifact Injection): Применение экипированного артефакта (например, «Флэш-Конденсатор» из Района Анархистов 2).Эффект: Добавляет тег SHOCK, конвертирует 20% урона в Электрический.Скейлинг Голоса (Voice Scaling): Проверка доминирующего Голоса игрока для данного типа оружия.Сценарий: У игрока «Авторитет» Ранга 5.Модификация: «Авторитет» модифицирует огнестрельное оружие, добавляя вторичное действие: «Угроза» (Threaten).Расчет Энтропии (Entropy Calculation): Применение «Уравнения Клина» (Jam Equation) на основе текущего состояния оружия.4.1.1 Реализация (TypeScript/Bun)TypeScript// services/combat/CardFactory.ts

interface Card {
  id: string;
  name: string;
  damage: number;
  damageType: 'PHYSICAL' | 'TECHNO' | 'BIO' | 'RITUAL';
  range: number; // допустимые ранги, напр. 
  apCost: number;
  staminaCost: number;
  effects: Effect;
  jamChance: number;
  tags: string;
}

export function synthesizeCard(weapon: Weapon, artifact: Artifact, voices: VoiceStats): Card {
  // 1. Инициализация базового объекта
  let card: Card = {
    id: crypto.randomUUID(),
    name: weapon.name,
    damage: weapon.baseDamage,
    damageType: weapon.damageType,
    range: weapon.validRanks,
    apCost: weapon.baseAp,
    staminaCost: weapon.baseStamina,
    effects: [...weapon.defaultEffects],
    jamChance: 0,
    tags:
  };

  // 2. Инъекция Артефакта (Artifact Injection)
  if (artifact && artifact.compatibility.includes(weapon.type)) {
    card.name = `${artifact.prefix} ${card.name}`; // напр. "Шоковый Glock"
    card.damage += artifact.bonusDamage;
    if (artifact.effect) card.effects.push(artifact.effect);
  }

  // 3. Скейлинг Голоса (Внутренний Парламент)
  // Пример: "Зверь" (Might) увеличивает урон дробящего оружия, но снижает точность
  if (weapon.type === 'BLUNT') {
    const mightFactor = voices.voiceMight * 0.05; // 5% за уровень
    card.damage = Math.floor(card.damage * (1 + mightFactor));
    
    // Открытие порога: Ранг 5 дает способность "Толчок"
    if (voices.voiceMight >= 5) {
      card.effects.push({ type: 'PUSH', value: 1 }); // Смещение ранга
      card.tags.push('WALL_SLAM_CAPABLE');
    }
  }
  
  // 4. Энтропия (Уравнение Клина / The Jam Equation)
  // P_jam = (100 - Condition) * 0.2 + (Heat * 0.1) - (TechSkill * 0.5)
  // Важно: рассчитывается на сервере, чтобы избежать клиентского манипулирования
  const techSkill = voices.voiceTech;
  let jamProb = (100 - weapon.condition) * 0.2 + (weapon.heat * 0.1) - (techSkill * 0.5);
  
  // Модификатор Анархистов (Sabotage)
  if (weapon.isSabotaged) jamProb += 25;

  card.jamChance = Math.max(0, Math.min(95, jamProb)); // Кап на 95%

  return card;
}
4.2 Система Рангов (Топология)Боевое поле определяется как массив из 8 слотов (4 вражеских, 4 игрока). База данных хранит это как целые числа current_rank (1-4). Однако логика движения требует строгого алгоритма для обработки коллизий, смещений и механики «Удара о Стену» (Wall Slam).4.2.1 Логика Смещения (Push/Pull)Когда Силовик FJR использует «Удар Щитом» (Push 1) против Мародера на Ранге 1:Цель: Мародер (Ранг 1).Действие: Push +1. Цель смещается на Ранг 2.Проверка Коллизии: Занят ли Ранг 2?Нет: Движение завершено.Да (Занят Снайпером): Происходит каскадное смещение. Снайпер выталкивается на Ранг 3.Удар о Стену (Wall Slam): Если юнит выталкивается с Ранга 4 (Арьергард) и ему некуда деваться:Состояние: WALL_SLAM.Эффект: Дополнительный Физический Урон (Формула: $Force \times 1.5$) + Статус STUN.Нарратив: Враг впечатывается в декорации арены.Эта логика должна выполняться внутри транзакции Drizzle, чтобы гарантировать, что ни один юнит не окажется в «суперпозиции» (два юнита на одном ранге), если смещение прервется ошибкой.4.3 Режим Нулевой Дистанции (Zero-Range Mode)В Арене Анархистов (Зона Бета) Система Рангов коллапсирует. Это фундаментальное изменение состояния боевого движка.Триггер: Боевая Локация = "Indoors/Arena" или "Elevator".Состояние Системы: Флаг is_zero_range = true.Эффект: Все проверки Рангов игнорируются. Дистанция неактуальна.Изменение Механик:Уравнение Клина (jamChance) становится более агрессивным (Нагрев накапливается в 2 раза быстрее из-за интенсивности боя).Карты «Движения» (Advance/Retreat) отключаются или конвертируются в «Уклонение» (Dodge), меняющее стэнс, а не позицию.Снайперское оружие (Min Range > 2) получает штраф к AP или становится неактивным.5. Деревья Поведения ИИ и Механизмы Принятия РешенийДля реализации «Логики Хищника», описанной в GDD 1, мы не можем полагаться на простые скрипты «Если HP < 50%, то Лечиться». Мы внедряем Иерархические Деревья Поведения (Hierarchical Behavior Trees - HBT) или GOAP (Goal Oriented Action Planning), хранящиеся в виде JSON-структур в базе данных и парсируемые сервером Bun во время хода ИИ.5.1 Логика Хищника (Сканирование Переменных)ИИ постоянно сканирует состояние игрока, ища флаги уязвимости, выводимые из «Внутреннего Парламента».Проверка Боеприпасов (Момент Щелчка):Ввод: ammo_count игрока.Условие: Если ammo_count == 0 И игрок еще не перешел в режим «Холодной Стали».Реакция (Мародер): Триггер поведения RUSH (покинуть укрытие, сократить дистанцию).Реакция (FJR): Триггер SUPPRESS (держать игрока подавленным огнем, пока он перезаряжается).Проверка Истощения:Ввод: stamina игрока vs max_stamina.Условие: Если stamina < 10 (Состояние Истощения).Реакция: Использовать способности KNOCKDOWN. Истощенный игрок не может пройти проверку Ловкости (Agility check), чтобы устоять на ногах.Реакция на Блеф (Голос: Авторитет):Ввод: Игрок использует карту «Угроза» (Threaten).Проверка: AI_Morale + AI_Resistance vs Player_Authority.Исход:Успех: ИИ входит в состояние COWER (пропуск хода, потеря инициативы).Провал: ИИ входит в состояние ENRAGED (Урон +20%, Точность -10%).5.2 Структура Дерева Поведения (JSON)Мы храним «мозг» NPC в поле npc_templates.ai_behavior_tree_id. Пример структуры JSON для «Мародера»:JSON{
  "root": {
    "type": "SELECTOR",
    "children":,
        "actions":
      },
      {
        "type": "SEQUENCE",
        "name": "Возможность Хищника",
        "conditions":,
        "actions":
      },
      {
        "type": "SEQUENCE",
        "name": "Координация Стаи",
        "conditions":,
        "actions":
      },
      {
        "type": "ACTION",
        "name": "Дефолтное Действие",
        "actions":
      }
    ]
  }
}
Сервер Bun парсит это дерево каждый тик. Такой подход, управляемый данными (Data-Driven), позволяет гейм-дизайнерам настраивать агрессивность ИИ без необходимости деплоя кода сервера.6. Кинетический Слой и Имплементация Энтропии«Кинетический Слой» — это симуляция физического износа и напряжения. В среде Bun это обрабатывается через middleware, которое перехватывает каждое действие «Атаки».6.1 Имплементация «Момента Щелчка»Клиент (Optimistic UI) отслеживает патроны визуально. Однако сервер является источником истины.Действие Клиента: Игрок разыгрывает карту «Выстрел».Проверка Сервера:if (weapon.ammo > 0) { ProcessAttack(); weapon.ammo--; }else { TriggerClickEvent(); }Событие Щелчка (The Click Event):Логика атаки отменяется (урон не наносится).weapon.heat не снижается (стресс остается).Пакет PANIC отправляется клиенту.Карта «Выстрел» сгорает из руки, заменяясь визуальным глитчем.Уведомление ИИ: «Черная доска» (Blackboard) ИИ обновляется статусом PLAYER_EMPTY: true.6.2 Протокол «Холодная Сталь» (Сдвиг Фазы)Когда ресурсы исчерпаны, игра меняет фазу. Это критическое изменение архитектурного состояния.Триггер: Игрок экипирует оружие ближнего боя или разыгрывает карту «Бросить Оружие» (при пустом магазине).Обновление БД: Поле combat_sessions.phase меняется с FIREFIGHT на MELEE.Замена Колоды (Deck Swap): Отношение card_decks для игрока «горячо» заменяется. «Стрелковая Колода» кэшируется, а «Рукопашная Колода» (сгенерированная из Голосов Силы/Тела) загружается в руку.Экономика Выносливости: Стоимость карт пересчитывается. Стрельба стоит AP; Рукопашная стоит AP + Stamina. Сервер должен валидировать наличие Stamina, отклоняя действие или превращая его в «Слабый Удар» (50% урона), если current_stamina слишком низка.7. Геолокация и Контекст ОкруженияИгра использует реальные данные карты (Mapbox) для влияния на состояние «Арены». Бэкенд должен запрашивать геопространственный контекст для применения модификаторов.7.1 Зональные Модификаторы (Интеграция API)Мы создаем сервис GeoContextService в Bun.Ввод: GPS-координаты игрока (Lat/Long).Логика: Определение Зоны (Альфа, Бета, Гамма) или суб-биома (Каналы, Собор) с помощью PostGIS.Модификаторы:Собор (Münster): «Святая Земля». Лечение +20%. Ритуальный урон +50%.Каналы (Bächle): «Скользко». Уклонение -10%. Электрический урон становится AoE (Проводимость воды).Индустриальный Север: «Магнитные Помехи». Шанс клина Техно-оружия +15%.7.2 Механика "Genius Loci"Редкие, мощные способности, привязанные к конкретным достопримечательностям.База Данных: Таблица landmarks с полями lat, long, radius и ability_id.Runtime: При инициализации боя сервер проверяет ST_DWithin (функция PostGIS через Drizzle), чтобы узнать, активен ли лендмарк.Эффект: Если рядом с Университетом, даровать «Академический Анализ» (Раскрыть намерения врага). Это инъекция временной карты с нулевой стоимостью в руку игрока.8. Сетевая Архитектура: Bun + Elysia WebSocketsДля достижения ощущения «Реального Времени» тиковой системы мы отказываемся от REST для боевого цикла.8.1 Жизненный Цикл Событий WebSocketМы определяем специфические опкоды (opcodes) для боевого протокола.CONNECT_COMBAT: Клиент присоединяется к каналу сессии. Сервер отправляет полный снимок CombatState.COMMIT_ACTION: Клиент отправляет намерение хода (Card ID + Target ID).Сервер: Валидирует AP, Дистанцию и Патроны.Сервер: Если валидно, добавляет в action_queue.TICK_UPDATE: Сервер рассылает новые значения Инициативы (Action Gauge) каждые 100мс.RESOLVE_TURN: Когда Action Gauge заполняется, сервер выполняет действие, рассчитывает урон/физику и рассылает TURN_RESULT.8.2 Optimistic UI и ОбработкаКлиент предсказывает результат. Если сервер (Bun) рассчитывает другой исход (например, скрытый «Рефлекс» врага сработал как прерывание):Реакция Клиента: Интерфейс проигрывает эффект «Глитча» (нарративно обоснованный как помехи AR), и состояние доски мгновенно синхронизируется с правдой сервера (STATE_CORRECTION). Это превращает техническое ограничение (задержку) в игровую фичу (туман войны/помехи).8.3 Безопасность: Слой Анти-ЧитаПоскольку клиент не доверен:Верификация Сида: Все ГСЧ (RNG) происходит на сервере. Клиенту отправляется seed для визуальных эффектов, но числа урона авторитарны от сервера.Валидация Инвентаря: Когда игрок пытается использовать «Glock-19», сервер проверяет npc_instances или player_inventory, чтобы убедиться, что предмет действительно есть и не уничтожен/выброшен.9. Детальный Анализ Систем: Уравнение КлинаЛогика отказа оружия (Энтропия) является центральной для «Экономики Дефицита». Это не простой рандомный бросок.Уравнение:$$P_{jam} = (100 - Condition) \times 0.2 + (Heat \times 0.1) - (TechVoice \times 0.5)$$Имплементация в Bun:TypeScriptconst calculateJamChance = (weapon: WeaponInstance, player: PlayerStats) => {
  const wearFactor = (100 - weapon.condition) * 0.2;
  const heatFactor = weapon.heat * 0.1;
  const skillFactor = player.voices.voiceTech * 0.5;
  
  // Базовый шанс
  let chance = wearFactor + heatFactor - skillFactor;
  
  // Модификатор Анархистов (Саботаж) из статус-эффектов
  if (player.statusEffects.includes('SABOTAGED')) {
    chance += 25;
  }
  
  return Math.max(0, Math.min(95, chance)); // Кап на 95%
};
Эта функция вызывается каждый раз, когда разыгрывается карта огнестрельного оружия. Если Math.random() * 100 < chance, срабатывает ClickEvent.10. ЗаключениеПредложенная архитектура для Project Echo использует сырую скорость Bun и безопасность Elysia/Drizzle для создания бэкенда, который является одновременно надежным и высокореактивным. Тесно связывая лор «Внутреннего Парламента» с реляционными схемами базы данных и рассматривая бой как серию авторитарных тиков сервера, мы гарантируем, что «Кинетический Слой» будет ощущаться физическим, честным и невероятно напряженным. Система выходит за рамки простых механик RPG, превращаясь в симуляцию стресса, энтропии и тактического выживания, идеально соответствуя нарративу «Эха Фрайбурга».Эта спецификация служит чертежом для инженерного спринта Alpha 0.4.