# Руководство по Картам: Глобальная (Mapbox) и Тактическая (Hex)

> ⚠️ Backend переехал на Bun + Elysia. Источник данных — REST в `server/src/api/routes/map.ts` и `survival.ts`.

---

## Часть 1: Глобальная Карта (Mapbox GL)

**Рендер**: Mapbox GL через обёртку `MapboxMap` + React‑слои/маркеры.
**Данные**: TanStack Query хук `useMapData` (точки + зоны).
**Взаимодействия**: выбор точки, попап, действия/сцены, туман войны.

### Архитектура и Файлы
- **Обёртка карты**: `src/shared/ui/MapboxMap.tsx`
- **Маркеры**: `src/widgets/map/map-view/MapMarkers.tsx`
- **Слои зон**: `src/widgets/map/map-view/FactionZonesLayer.tsx`
- **Туман**: `src/widgets/map/map-view/FogOfWarLayer.tsx`
- **Backend**: `server/src/api/routes/map.ts`

### Ключевые Механики
1.  **Туман Войны**: Скрывает карту. Открывается динамически по мере обнаружения (`/map/discover`) или исследования точек.
2.  **Зоны**:
    *   **Safe Zones**: Безопасные зоны фракций.
    *   **Danger Zones**: Опасные зоны с вероятностью спауна врагов.
3.  **Враги (Enemy Layer)**: Красные пинги и маркеры, появляющиеся при визуальном контакте или шуме.

---

## Часть 2: Тактическая Гекс-Карта (Survival Mode)

Гексагональная карта используется в режиме выживания для пошагового исследования, менеджмента ресурсов и тактических столкновений.

**Источник истины**: `server/src/services/survivalService.ts` (State Authoritative).
**Генерация**: `server/src/shared/hexmap/mapGenerator.ts`.

### 1. Структура Карты и Биомы

Карта генерируется процедурно (`radius=14`). Каждый гекс имеет **Биом**, **Уровень Угрозы** и **Ресурс**.

#### Биомы и Ресурсы
| Биом (Код) | Название | Типичный Лут (Resource) | Описание |
| :--- | :--- | :--- | :--- |
| **HOSPITAL** | Больница | **TECH** (Medikit, Radio), Medicine | Высокотехнологичная зона. |
| **INDUSTRIAL** | Промзона | **FUEL**, Scrap | Заводы, склады ГСМ. |
| **MARKET/KITCHEN** | Торговый ряд | **FOOD**, Water | Бывшие магазины и столовые. |
| **RESIDENTIAL** | Жилой сектор | **SCRAP**, Gear | Квартиры, личные вещи. |
| **BASE** | База | None (Safe) | Стартовая точка (0,0). |

**TECH ресурсы**: Дают специфичные предметы вроде `repair_kit_small` (починка) и `radio` (торговля/квесты).

### 2. Система Угроз (Threat System)

Уровень угрозы определяет шанс успеха действий (разведка, бой, обезвреживание).

| Уровень | Шанс Успеха | Примечание |
| :--- | :--- | :--- |
| **SAFE** | 85% | Почти безопасно. |
| **LOW** | 75% | Низкий риск. |
| **MEDIUM** | **60%** | Средний риск (стандарт). |
| **HIGH** | 45% | Опасно! Высокий шанс врагов. |
| **EXTREME** | 30% | Смертельно. Требуется подготовка. |

При провале проверки часто следует **Ранение (Wound)** или потеря **Морали**.

### 3. Исследование и Роли (Scouting)

Основное действие: `[РАЗВЕДАТЬ СЕКТОР]`. Без разведки вход в сектор невозможен (или крайне опасен в будущем).

#### Бонусы Ролей
*   **Scout (Разведчик)**:
    *   **+25% к шансу разведки** (Итого: Medium = 85%, High = 70%).
    *   Видит угрозу и лут в соседних гексах **до** входа (пассивка).
    *   Опция `[ПРОКРАСТЬСЯ]` при встрече врага (Avoid Combat).
*   **Techie (Техник)**:
    *   **+25% к обезвреживанию ловушек**.
    *   Получает дополнительный лут (детали) при разборе ловушек.
*   **Enforcer (Силовик)**:
    *   Начинает с пистолетом.
    *   Опции силового решения.

### 4. Типы Событий (Encounters)

После разведки гекс получает статус (Encounter Type), который сохраняется до зачистки:

1.  **ENEMY (Враг)**:
    *   *Fight*: Бой (риск ранения, трата патронов/прочности).
    *   *Sneak* (Scout): Избежать боя.
    *   *Retreat*: Отступить назад.
2.  **SURVIVOR (Выживший)**:
    *   *Recruit*: Нанять за еду (+Мораль базе).
    *   *Trade*: Обмен (Radio -> Resources).
3.  **TRAP (Ловушка)**:
    *   *Disarm* (Requires Techie for safe/profit): Обезвредить.
    *   *Risk*: Попытаться проскочить (высокий риск ранения).
4.  **LOOT (Находка)**:
    *   *Scavenge*: Безопасный сбор ресурсов.

### 5. Перемещение и Выносливость

*   **Server Authoritative**: Клиент отправляет намерение "Move to Hex X". Сервер рассчитывает путь и время прибытия (`arriveAtWorldTimeMs`).
*   **Время**: Перемещение занимает время (по умолчанию 120 лоровых минут на гекс).
*   **Stamina**:
    *   Тратится на движение.
    *   Восстанавливается со временем (быстрее в Бункере/Базе).
    *   Восстанавливается едой/водой.

### 6. Интеграция (Backend)

*   `POST /survival/sessions/:id/move` — начать движение.
*   `POST /survival/sessions/:id/zone-action` — взаимодействие с гексом (scout, scavenge).
*   Состояние хранится в `SurvivalState.players[id].hexPos` и `movementState`.
