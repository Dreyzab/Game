import { mutation } from './_generated/server'

type LngLat = [number, number]

function polyToLatLng(points: LngLat[]): { lat: number; lng: number }[] {
  return points.map(([lng, lat]) => ({ lat, lng }))
}

const SAFE_ZONES = [
  // Synthesis
  {
    id: 'synthesis_corridor',
    name: 'Synthesis Corridor',
    faction: 'synthesis',
    polygon: polyToLatLng([
      [7.849859242096642, 47.994884766604],
      [7.848834490861151, 47.995133296620565],
      [7.847706576751563, 47.99516551338681],
      [7.847273292671019, 47.99515630859847],
      [7.846674947991005, 47.995243754021544],
      [7.846427357088032, 47.99441531775142],
      [7.845615809130294, 47.994479752160316],
      [7.845670829332107, 47.99462703050759],
      [7.844687343246818, 47.99474209142403],
      [7.844474139970629, 47.993761764197274],
      [7.845423238429191, 47.99365590615241],
      [7.846963804044208, 47.99288267558725],
      [7.848669430260202, 47.992514466483556],
      [7.848834490861151, 47.99373875159742],
      [7.849859242096642, 47.994884766604],
    ]),
  },
  // Ordnung / FJR strip
  {
    id: 'ordnung_strip',
    name: 'Ordnung Strip',
    faction: 'fjr',
    polygon: polyToLatLng([
      [7.850326908922227, 47.9954554639676],
      [7.849687299091983, 47.99578683339158],
      [7.848160488527043, 47.99609979144961],
      [7.8478234897985715, 47.99575461701329],
      [7.8451899188853815, 47.99617842264203],
      [7.845010341943578, 47.99564801736295],
      [7.846669880572023, 47.9952502098258],
      [7.848211765341603, 47.995262641357755],
      [7.849908457818344, 47.994955996028665],
      [7.850326908922227, 47.9954554639676],
    ]),
  },
  // FJR North Sector (formerly sector_1)
  {
    id: 'sector_1',
    name: 'FJR Sector 1',
    faction: 'fjr',
    polygon: polyToLatLng([
      [7.848624977172506, 47.99852100816156],
      [7.848151512568677, 47.99778861678473],
      [7.847696494636267, 47.99741007334552],
      [7.848618828281559, 47.997047985718666],
      [7.849461226343351, 47.99685459696741],
      [7.850715600100926, 47.99669001022551],
      [7.851533402598847, 47.99643489973775],
      [7.8531355052890035, 47.99794598845136],
      [7.848624977172506, 47.99852100816156],
    ]),
  },
  // Mayor District (neutral)
  {
    id: 'mayor_district',
    name: "Mayor's District",
    faction: 'neutral',
    polygon: polyToLatLng([
      [7.851471649958853, 47.996424655866235],
      [7.8507499288465965, 47.99664044567527],
      [7.849406299115969, 47.996820269826344],
      [7.84878439049848, 47.99696412869605],
      [7.847678775177229, 47.99737001405856],
      [7.846620484634428, 47.99607003930814],
      [7.847746221879703, 47.995769532686325],
      [7.8481583770458485, 47.99613178702765],
      [7.849708572597905, 47.995814814617916],
      [7.850409851536341, 47.995436091783205],
      [7.851471649958853, 47.996424655866235],
    ]),
  },
  // Old Believers
  {
    id: 'old_believers_district',
    name: 'Old Believers District',
    faction: 'old_believers',
    polygon: polyToLatLng([
      [7.853389873557859, 47.99797841878066],
      [7.851084270377385, 47.99595742546333],
      [7.851798816818132, 47.99562589849697],
      [7.851636852957938, 47.99540912971301],
      [7.853224834963015, 47.995044813978865],
      [7.853342656706786, 47.99537942638338],
      [7.853721985250189, 47.995412118283866],
      [7.854058954101731, 47.995378907523644],
      [7.854034139982531, 47.99512508190614],
      [7.856295062134393, 47.994709338592116],
      [7.857264683923802, 47.995768362868176],
      [7.855384443540572, 47.99634421605117],
      [7.855854542981717, 47.997249736256435],
      [7.853389873557859, 47.99797841878066],
    ]),
  },
  // Merchants (neutral)
  {
    id: 'merchants_quarter',
    name: 'Merchants Quarter',
    faction: 'neutral',
    polygon: polyToLatLng([
      [7.851039295867167, 47.995898965850245],
      [7.850442576105621, 47.99538813192132],
      [7.849907418179612, 47.99478784680727],
      [7.850840121994878, 47.99446041561947],
      [7.852367165691334, 47.99421180672357],
      [7.853424688241432, 47.993903827983786],
      [7.853963509797239, 47.99347204334791],
      [7.854193452755055, 47.9930425518545],
      [7.854464579524432, 47.99302188105028],
      [7.856224137505734, 47.99468993361717],
      [7.854015863760026, 47.99509576055715],
      [7.8540253929875234, 47.99536601390446],
      [7.853718859928705, 47.99539531805004],
      [7.853352896991481, 47.99537020021194],
      [7.853246548787922, 47.99500180385391],
      [7.8521948688333225, 47.99516718892042],
      [7.85158993801852, 47.99541111571702],
      [7.851706270866998, 47.99560833228364],
      [7.851039295867167, 47.995898965850245],
    ]),
  },
  // Anarchists
  {
    id: 'anarchists_ring',
    name: 'Anarchists Ring',
    faction: 'anarchists',
    polygon: polyToLatLng([
      [7.852221190623652, 47.99385949345765],
      [7.852116589810919, 47.99386703323884],
      [7.851897070986809, 47.99387997883605],
      [7.851719620819296, 47.99388892962759],
      [7.85103578094737, 47.993959830371125],
      [7.850959472984869, 47.99324386461291],
      [7.852745404353442, 47.99322814835128],
      [7.852845496780361, 47.99320512270023],
      [7.85300189119738, 47.993131859196154],
      [7.8534272840144865, 47.99276763337582],
      [7.853521120664709, 47.9928283378575],
      [7.853633724644965, 47.99275088729934],
      [7.853783863285315, 47.99285764344427],
      [7.852951899212883, 47.99360441060992],
      [7.852402729922744, 47.99372879897899],
      [7.852397097417196, 47.99370052892152],
      [7.852250652272232, 47.993721260298514],
      [7.85234282166374, 47.99385501184972],
      [7.852221190623652, 47.99385949345765],
    ]),
  },
  // Artisan (neutral)
  {
    id: 'artisan_quarter',
    name: 'Artisan Quarter',
    faction: 'neutral',
    polygon: polyToLatLng([
      [7.849875507366221, 47.99473623211378],
      [7.849040092661141, 47.993831143309706],
      [7.848701939354697, 47.99249384396484],
      [7.849364933381565, 47.99217759634203],
      [7.853349704874233, 47.992070051367335],
      [7.853772975630875, 47.992503483806956],
      [7.852891405256116, 47.99312092330587],
      [7.850936212874501, 47.993212478665896],
      [7.85103054980533, 47.99400076611818],
      [7.852371289281649, 47.993871649130284],
      [7.852322282009908, 47.99373977622045],
      [7.85301928299242, 47.993603232098565],
      [7.854067711532025, 47.99267078075971],
      [7.854235112312637, 47.99277935159722],
      [7.853937049208838, 47.99343442010593],
      [7.853358710229088, 47.993883094496795],
      [7.852376069172635, 47.99417185909965],
      [7.8504693660612475, 47.99449930322956],
      [7.849875507366221, 47.99473623211378],
    ]),
  },
  // Bazaar (neutral)
  {
    id: 'grand_bazaar',
    name: 'Grand Bazaar',
    faction: 'neutral',
    polygon: polyToLatLng([
      [7.84665250139625, 47.99523191491116],
      [7.845920487598647, 47.99538499534191],
      [7.845641407338519, 47.99448487589379],
      [7.846414596912041, 47.994429766029924],
      [7.84665250139625, 47.99523191491116],
    ]),
  },
]

export const seedSafeZones = mutation({
  handler: async (ctx) => {
    let created = 0
    let updated = 0
    const skipped = 0
    const now = Date.now()

    for (const z of SAFE_ZONES) {
      const existing = await ctx.db
        .query('safe_zones')
        .filter((q) => q.eq(q.field('id'), z.id))
        .first()
      if (existing) {
        // Upsert: patch existing with latest props
        await ctx.db.patch(existing._id, {
          name: z.name,
          faction: z.faction,
          polygon: z.polygon,
          isActive: true,
        })
        updated++
        continue
      }
      await ctx.db.insert('safe_zones', {
        id: z.id,
        name: z.name,
        faction: z.faction,
        polygon: z.polygon,
        isActive: true,
        createdAt: now,
      })
      created++
    }

    return {
      success: true,
      created,
      updated,
      skipped,
      total: SAFE_ZONES.length,
    }
  },
})

export const clearSafeZones = mutation({
  handler: async (ctx) => {
    const zones = await ctx.db.query('safe_zones').collect()
    for (const z of zones) await ctx.db.delete(z._id)
    return { success: true, deleted: zones.length }
  },
})
