# Требования и User Story — Grenzwanderer (QR‑Boost)

## Назначение
- Мобильная/веб игра с картой (Mapbox) и визуальными сценами (Visual Novel), где игрок исследует город, открывает точки интереса (Map Points), выполняет квесты и продвигает сюжет.
- Ключевые механики: активируемые точки на карте, сцены-диалоги с выбором и проверками навыков, QR‑активация объектов в реальном мире, «безопасные зоны» фракций, прогресс и репутации, трекинг квестов.

## Роли и пользователи
- Игрок
  - Гость по `deviceId` (без регистрации) или авторизованный пользователь (Clerk).
  - Исследует карту, сканирует QR, проходит сцены, получает опыт/уровни/очки навыков, продвигает квесты.
- Администратор/Девелопер (dev)
  - Засевает тестовые данные (map points, safe zones, quests), чистит коллекции, смотрит статистику из DevTools.

## Область решения (Scope)
- Карта с точками и слоями (Safe Zones), фильтрами, списком локаций, выделением выбранной точки.
- Система квестов: доступные/активные, обновление шагов, завершение и награды, привязка к точкам.
- Визуальная новелла: сцены, реплики, выборы, проверки навыков, эффекты на прогресс (флаги, опыт, репутация).
- QR‑активация: сканирование кода, подтверждение и начисление опыта, статус «исследовано».
- Прогресс игрока: флаги, текущая сцена, посещённые сцены, фаза, уровень, XP, очки навыков, репутация.
- Безопасные зоны (полигоны) с фракциями и подписями, переключаемый слой на карте.
- Главная (дашборд): статус игрока, быстрые действия, активные квесты, системный статус.
- DevTools: сиды, очистка, массовые операции для теста.

## Навигация и экраны
- `/` — ModernHomePage: приветствие, старт, создание/проверка игрока (ensureByDevice), виджеты.
- `/map` — MapPage: карта, фильтры, легенда, список точек, HUD мира, меню взаимодействия с точкой.
- `/enhanced-map` — MapPage (alias): альтернативный путь на ту же карту.
- `/visual-novel` — VisualNovelPage: запуск сцены по `sceneId`, диалоги/выбор (полноэкранно, без навбара).
- `/prologue` — VisualNovelPage (пролог): стартовая сюжетная сцена (полноэкранно, без навбара).
- `/character` — CharacterPage: распределение очков навыков, просмотр характеристик.
- `/inventory` — InventoryPage: базовый инвентарь/экипировка (MVP).
- `/settings` — SettingsPage: UI‑настройки, сид‑операции и инструменты данных (для dev).
- `/dev-tools` — DevToolsPage: сиды, очистка, статистика (dev‑режим).

## Навбар (общая навигация)
- Состав пунктов:
  - Home (`/`), Map (`/map`), Prologue (`/prologue`), Character (`/character`), Inventory (`/inventory`), Settings (`/settings`), DevTools (`/dev-tools`).
- Поведение и UX:
  - Фиксируется вверху, поверх контента; полупрозрачный фон с blur, граница по токенам темы.
  - Скрывается на полноэкранных VN‑маршрутах: `/prologue`, `/visual-novel`.
  - Активная ссылка подсвечивается (цвет/фон/граница), неактивные — приглушены; при hover — контрастнее.
  - Иконки `lucide-react` рядом с названиями; компактная высота, горизонтальный скролл на мобильных.
  - Доступность: кликабелен логотип (домой), фокус‑стили для клавиатуры, корректные aria‑атрибуты допустимы (расширение по мере надобности).
- Критерии приёмки:
  - Навбар виден на всех страницах, кроме `/prologue` и `/visual-novel`.
  - Клик по элементам ведёт на соответствующие маршруты; активное состояние соответствует текущему URL.
  - На узких экранах навигация не ломает макет (переполнение допускает прокрутку по оси X).
  - Навбар рендерится один раз на уровне роутера и не приводит к перерисовкам карты при навигации между не‑VN страницами.

## Назначение страниц (детализация)
- Home (`/`): дашборд игрока — виджеты статуса, быстрых действий, активных квестов, системного состояния; кнопка «Начать/Продолжить» выполняет `ensureByDevice` и ведёт в пролог или на экран персонажа при наличии свободных skill points.
- Map (`/map`, `/enhanced-map`): интерактивная карта с `MapView`, фильтрами, `PointsListPanel`, `MapLegendPanel`, HUD мира; выбор точки открывает `InteractionMenu` или стартует сцену; переключаемые Safe Zones.
- Prologue (`/prologue`): прологовая сцена VN, полноэкранный режим; по завершении выставляет флаги (например, `arrived_at_freiburg`) и может активировать цель на карте.
- Visual Novel (`/visual-novel`): универсальный экран VN по `sceneId`; скрывает навбар; фиксирует выборы и эффекты через `commitScene`.
- Character (`/character`): распределение `skillPoints`, просмотр текущих `skills` и уровня; сохранение в `game_progress`.
- Inventory (`/inventory`): базовое представление экипировки/предметов (MVP), переходы назад на Home/Map.
- Settings (`/settings`): UI‑настройки (скорость тайпрайтера, оверлеи), dev‑панель для сидов (map points, safe zones, quests), массовые операции; блокировки в продакшене при необходимости.
- DevTools (`/dev-tools`): расширенные dev‑операции (сид/очистка/статистика), дубль критичных функций из Settings.

## Основные пользовательские истории и критерии приёмки

### 1) Первый запуск и старт игры
- Как игрок, я хочу быстро начать игру без регистрации, чтобы сразу попасть в сюжет/карту.
  - При первом заходе генерируется/считывается `deviceId`.
  - Кнопка «Начать» вызывает `player.ensureByDevice(deviceId)`; при успехе создаются `players` и `game_progress` с базовыми значениями.
  - Если у игрока есть нераспределённые очки навыков — переход на экран персонажа (`/character`), иначе в пролог (`/prologue`) или на карту по дизайну.
  - Отображается понятное сообщение об ошибке при недоступности сервера.

### 2) Карта и взаимодействие с точками
- Как игрок, я хочу видеть интерактивную карту с точками и безопасными зонами, чтобы планировать маршрут и взаимодействовать с миром.
  - Карта отображает точки в текущем `bbox`; список точек и фильтры (категория, фракция, выполненные, поиск) работают согласованно.
  - Нажатие на метку выбирает точку и открывает соотв. меню взаимодействия (если оно есть) или сразу запускает сцену.
  - Включение опции «Safe Zones» отображает полигоны фракций с подписями; выключение — скрывает слои.
  - Кнопка «Центр на мне» запрашивает геолокацию и центрирует карту.
  - Автовыбор целевой точки при активном квесте или флагах (например, `info_bureau` после пролога) не мешает ручному выбору.

### 3) Условия доступности: фаза/флаги/навыки/репутация
- Как игрок, я хочу видеть и запускать только доступные по условиям точки/сцены, чтобы прогресс был логичным.
  - `listVisible` возвращает точки с учётом `phase`, `unlockRequirements.flags`, и др. условий.
  - Алгоритм `getBestSceneBinding`/`checkSceneConditions` отфильтровывает недоступные биндинги и сортирует по приоритету.
  - Недоступные опции меню не показываются.

### 4) Меню взаимодействия и запуск сцены (VN)
- Как игрок, я хочу выбирать, что делать в локации, и при выборе попадать в сцену визуальной новеллы.
  - При клике по точке, если для неё настроено `interactionMenu`, показываются опции с учётом условий.
  - Выбор опции приводит к навигации `/visual-novel` со `sceneId`.
  - Если меню не требуется, сцена запускается сразу.

### 5) Визуальная новелла: выборы, проверки навыков, эффекты
- Как игрок, я хочу, чтобы мои выборы влияли на мир: добавляли флаги, опыт, меняли репутацию, открывали новые сцены.
  - Сцена отображает диалог/выборы; некоторые варианты требуют проверок навыков (вероятность успеха видима/информативна).
  - По завершении сцены фронтенд вызывает `quests.commitScene` или `vn.commitScene` с `effects` (flags/xp/reputation и т.п.).
  - Бэкенд обновляет `game_progress` (флаги, xp, level‑up, skillPoints, visitedScenes, phase при необходимости).
  - Возвращается подсказка следующей цели (например, `getNextStep` -> `find_info_bureau`).

### 6) Квесты: старт, прогресс, завершение
- Как игрок, я хочу понятные цели и награды, чтобы понимать прогресс.
  - Доступные квесты определяются по фазе и выполненным предпосылкам; активные квесты отслеживаются в сторах/виджетах.
  - `startQuest(deviceId, questId, initialStep)` создаёт запись `quest_progress`.
  - `updateQuestProgress(..., newStep)` обновляет текущий шаг; `completeQuest(..., finalStep)` помечает завершение и начисляет награды (в т.ч. XP в `game_progress`).
  - Привязки точек (`mappoint_bindings`) позволяют активировать/продвигать квест, посетив нужную локацию.

### 7) QR‑активация точки
- Как игрок, я хочу сканировать QR‑код, чтобы «исследовать» объект и получить опыт.
  - Из UI доступна панель `QRPointActivation` с кнопкой «Сканировать» и камерой.
  - Успешный скан вызывает `mapPoints.activateByQR(deviceId, qrCode)`: в `point_discoveries` фиксируется открытие/исследование; в `game_progress` начисляется XP (по `danger_level`).
  - Показывается успех (название точки, +XP) и авто‑закрытие панели через ~3 секунды.
  - При ошибке (неизвестный QR, сетевые проблемы) — информативное сообщение, без краша UI.

### 8) Главная (дашборд)
- Как игрок, я хочу видеть свой статус и быстрые действия, чтобы возвращаться в игру удобно.
  - Отображаются виджеты: статус игрока, активные квесты, системный статус.
  - Кнопка «Начать/Продолжить» корректно инициализирует игрока (`ensureByDevice`) и ведёт в корректную точку входа.

### 9) Dev‑инструменты (для разработчиков)
- Как разработчик, я хочу быстро засеять/очистить данные и проверить взаимодействия.
  - Кнопки: seed map points (`mapPointsSeed`), seed safe zones (`zonesSeed`), seed quests (`quests.seedBaseQuests`, `quests.seedStoryQuests`), очистка коллекций, массовые открытия.
  - Статусы и ошибки показываются в UI, все операции защищены от выполнения в продакшн‑окружении (где это требуется).

## Данные и модели (ключевые)
- players: `userId?`, `deviceId`, `name`, `fame`, `phase`, `skills?`, `level?`, `xp?`, `skillPoints?`.
- game_progress: `deviceId? | userId?`, `currentScene`, `visitedScenes[]`, `flags{}`, `phase?`, `skills{}`, `level`, `xp`, `skillPoints`.
- map_points: `id`, `title`, `description`, `coordinates{lat,lng}`, `type`, `phase?`, `isActive`, `metadata{...}` (включая `sceneBindings`, `unlockRequirements`, `qrCode`, `qrHint`, `danger_level`).
- point_discoveries: `deviceId? | userId?`, `pointKey`, `discoveredAt?`, `researchedAt?`.
- mappoint_bindings: `mapPointId`, `questId`, `stepId?`, `bindingType(start|progress|complete)`, `requirements`.
- quests / quest_progress: квесты с шагами, прогресс игрока, завершение, награды.
- safe_zones: `id`, `name`, `faction`, `polygon[]`, `isActive`.

## Бизнес‑правила и расчёты
- Опыт за исследование точки: `low=50`, `medium=75`, `high=125`.
- Повышение уровня: требование XP по формуле `req(lvl) = 50*lvl + 50`; за уровень +1 `skillPoint`.
- Фильтрация видимости точек: по `bbox`, `phase` и `unlockRequirements`.
- Автоподсказка цели после сцены: `getNextStep` анализирует флаги/контекст и возвращает квест/шаг/точку.

## Нефункциональные требования
- UX/Анимации: плавные анимации (Framer Motion), понятные состояния загрузки/успеха/ошибки.
- Производительность: отрисовка карты без лагов; обновление слоёв безопасных зон без мерцания; лимиты на выдачу точек с сервера, debounce на фильтрах.
- Надёжность: идемпотентные сиды; валидация входных данных на сервере; аккуратные логи/варнинги.
- Мобильность: корректная работа геолокации, быстрая реакция кнопки «Центр на мне»; адаптивная верстка.
- Безопасность: Dev‑операции недоступны в продакшене, QR‑активации проверяют права и корректность входных данных.

## Ограничения и допущения
- Геолокация доступна и разрешена пользователем; при запрете — показывать уведомление и давать альтернативы.
- Сканер QR имеет доступ к камере; при отсутствии — дать ввод кода вручную (расширение в будущем).
- Часть контента (сцены/квесты) — сид‑данные для демонстрации; в проде будет контент‑пайплайн.

## Открытые вопросы
- Требуются ли офлайн‑сценарии (кэш карт/точек, запись прогресса)?
- Нужны ли региональные ограничения видимости точек (по дистанции от игрока)?
- Политика коллизий флагов между VN и системными флагами (при мердже)?
- Модель репутации фракций: базовые правила изменения и эффекты доступа.

## Связка с кодовой базой (ориентиры)
- Маршруты и экраны: `client/src/pages/MapPage/MapPage.tsx`, `client/src/pages/VisualNovelPage/VisualNovelPage.tsx`, `client/src/pages/ModernHomePage.tsx`, `client/src/pages/DevToolsPage.tsx`.
- Карта и взаимодействие: `client/src/widgets/map/map-view/MapView.tsx`, `client/src/features/map-interaction/model/useMapPointInteraction.ts`, `client/src/features/map-interaction/lib/sceneBindingChecker.ts`.
- Точки, слои, безопасные зоны: `client/src/entities/map-point/*`, `client/src/widgets/map/map-view/SafeZonesControl.ts`.
- Бэкенд Convex: `client/convex/mapPoints.ts`, `client/convex/quests.ts`, `client/convex/vn.ts`, `client/convex/zonesSeed.ts`, `client/convex/schema.ts`.
- QR активация: `client/src/entities/map-point/ui/QRPointActivation.tsx`, `client/convex/mapPoints.ts (activateByQR)`.

---
Этот документ фиксирует ожидаемое поведение для текущего функционала. Если хочешь — могу разбить на детальные спецификации по экранам/модулям или добавить диаграммы потоков.
