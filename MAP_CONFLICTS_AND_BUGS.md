# –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã, –±–∞–≥–∏ –∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ –∫–∞—Ä—Ç—ã

## üî¥ –ö–†–ò–¢–ò–ß–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### 1. –ö–æ–Ω—Ñ–ª–∏–∫—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω—ã–º–∏ –∑–æ–Ω–∞–º–∏

**–ü—Ä–æ–±–ª–µ–º–∞**: –î–≤–∞ —Ä–∞–∑–Ω—ã—Ö –º–µ—Ö–∞–Ω–∏–∑–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω—ã–º–∏ –∑–æ–Ω–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç –¥—Ä—É–≥ —Å –¥—Ä—É–≥–æ–º.

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**:
- `src/widgets/map/map-view/SafeZonesControl.ts` - –∫–ª–∞—Å—Å-–∫–æ–Ω—Ç—Ä–æ–ª (–ù–ï –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø)
- `src/widgets/map/map-view/FactionZonesLayer.tsx` - React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç (–ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø)
- `src/shared/hooks/useMapData.ts:103-173` - —Ö—É–∫ `useSafeZones` (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è, –Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

**–î–µ—Ç–∞–ª–∏**:
```typescript
// MapView.tsx:117-120
const { isLoading: isZonesLoading } = useSafeZones({
  bbox,
  enabled: showSafeZones,
})
// ‚ö†Ô∏è –†–µ–∑—É–ª—å—Ç–∞—Ç zones –ù–ï –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø!

// MapView.tsx:275-278
<FactionZonesLayer
  map={map}
  visible={showSafeZones}  // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è FactionZonesLayer –≤–º–µ—Å—Ç–æ SafeZonesControl
/>
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è**:
- `SafeZonesControl` —Å–æ–∑–¥–∞–Ω, –Ω–æ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
- `useSafeZones` –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∫ —Å–µ—Ä–≤–µ—Ä—É, –Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è
- `FactionZonesLayer` –¥–µ–ª–∞–µ—Ç —Å–≤–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ `useQuery`
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ —Å–µ—Ä–≤–µ—Ä—É
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã ID –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤/—Å–ª–æ—ë–≤ –Ω–∞ –∫–∞—Ä—Ç–µ

**–†–µ—à–µ–Ω–∏–µ**:
1. –£–¥–∞–ª–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π `SafeZonesControl` –ò–õ–ò
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `SafeZonesControl` –≤–º–µ—Å—Ç–æ `FactionZonesLayer` –ò–õ–ò
3. –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É –≤ –æ–¥–∏–Ω –∫–æ–º–ø–æ–Ω–µ–Ω—Ç

---

### 2. –ë–∞–≥: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –≤ handleQRScan

**–ü—Ä–æ–±–ª–µ–º–∞**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `pointId: qrTargetPoint._id`, –Ω–æ —Ñ—É–Ω–∫—Ü–∏—è –æ–∂–∏–¥–∞–µ—Ç –¥—Ä—É–≥–æ–π —Ñ–æ—Ä–º–∞—Ç.

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `src/pages/MapPage.tsx:129-130`

```typescript
const result = await activateByQR({
  pointId: qrTargetPoint._id,  // ‚ö†Ô∏è –ë–ê–ì: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è _id
  qrCode: data,
  deviceId
})
```

**–ü—Ä–æ–±–ª–µ–º–∞ –≤ –±—ç–∫–µ–Ω–¥–µ**: `convex/mapPoints.ts:545-648`
```typescript
export const activateByQR = mutation({
  args: {
    deviceId: v.optional(v.string()),
    userId: v.optional(v.string()),
    qrCode: v.string(),  // ‚ö†Ô∏è –ù–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ pointId!
  },
  // ...
})
```

**–î–µ—Ç–∞–ª–∏**:
- –í `MapPage.tsx` –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è `pointId`, –Ω–æ —Ñ—É–Ω–∫—Ü–∏—è `activateByQR` –µ–≥–æ –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç
- –§—É–Ω–∫—Ü–∏—è –∏—â–µ—Ç —Ç–æ—á–∫—É —Ç–æ–ª—å–∫–æ –ø–æ `qrCode`
- –ü–∞—Ä–∞–º–µ—Ç—Ä `pointId` –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è (–µ—Å–ª–∏ –æ–Ω –≤–æ–æ–±—â–µ –¥–æ—Ö–æ–¥–∏—Ç –¥–æ —Ñ—É–Ω–∫—Ü–∏–∏)

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è**:
- –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –≤ –∑–∞–ø—Ä–æ—Å–µ
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—É—Ç–∞–Ω–∏—Ü–∞ –ø—Ä–∏ –æ—Ç–ª–∞–¥–∫–µ
- –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –º–µ–∂–¥—É —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º –∏ –±—ç–∫–µ–Ω–¥–æ–º

**–†–µ—à–µ–Ω–∏–µ**:
1. –£–¥–∞–ª–∏—Ç—å `pointId` –∏–∑ –≤—ã–∑–æ–≤–∞ –≤ `MapPage.tsx` –ò–õ–ò
2. –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é `pointId` –≤ `activateByQR` –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏

---

### 3. –ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–π: selectedPoint vs selectedPointId

**–ü—Ä–æ–±–ª–µ–º–∞**: –î–≤–∞ —Ä–∞–∑–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–æ—á–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã.

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**:
- `src/pages/MapPage.tsx:36` - `const [selectedPoint, setSelectedPoint] = useState<MapPoint | null>(null)`
- `src/widgets/map/map-view/MapView.tsx:77` - `const [selectedPointId, setSelectedPointId] = useState<string | null>(null)`

**–î–µ—Ç–∞–ª–∏**:
```typescript
// MapPage.tsx:61-64
const handleSelectPoint = useCallback((point: MapPoint | null) => {
  setSelectedPoint(point)  // –û–±–Ω–æ–≤–ª—è–µ—Ç selectedPoint
  console.log('Selected point:', point)
}, [])

// MapView.tsx:218-241
const handleSelectPoint = useCallback((point: MapPoint | null) => {
  setSelectedPointId(point?.id || null)  // –û–±–Ω–æ–≤–ª—è–µ—Ç selectedPointId
  onSelectPoint?.(point)  // –í—ã–∑—ã–≤–∞–µ—Ç –∫–æ–ª–±—ç–∫ –∏–∑ MapPage
}, [map, onSelectPoint])
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è**:
- `selectedPoint` –≤ `MapPage` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ –∫–æ–ª–±—ç–∫
- `selectedPointId` –≤ `MapView` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –≤—ã–±–æ—Ä–∞ —Ç–æ—á–∫–∏

**–†–µ—à–µ–Ω–∏–µ**:
1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ `selectedPointId` –∏ –Ω–∞—Ö–æ–¥–∏—Ç—å —Ç–æ—á–∫—É –ø–æ ID –ò–õ–ò
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ `selectedPoint` –∏ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç —Ü–µ–ª–∏–∫–æ–º

---

## üü° –í–ê–ñ–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### 4. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ getIconForPoint

**–ü—Ä–æ–±–ª–µ–º–∞**: –û–¥–Ω–∞ –∏ —Ç–∞ –∂–µ —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö —Å –∏–¥–µ–Ω—Ç–∏—á–Ω–æ–π –ª–æ–≥–∏–∫–æ–π.

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**:
- `src/entities/map-point/ui/MapPointMarker.tsx:42-96`
- `src/entities/map-point/ui/MapPointPopup.tsx:49-103`

**–î–µ—Ç–∞–ª–∏**:
- –û–±–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–º–µ—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—É—é –ª–æ–≥–∏–∫—É –≤—ã–±–æ—Ä–∞ –∏–∫–æ–Ω–∫–∏
- –û–±–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —É—Å–ª–æ–≤–∏—è –¥–ª—è —Ñ—Ä–∞–∫—Ü–∏–π –∏ —Å–µ—Ä–≤–∏—Å–æ–≤
- –†–∞–∑–ª–∏—á–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ä–∞–∑–º–µ—Ä –∏–∫–æ–Ω–∫–∏ (`w-4 h-4` vs `w-5 h-5`)

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è**:
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ (~50 —Å—Ç—Ä–æ–∫)
- –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª–æ–≥–∏–∫–∏ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å –¥–≤–∞ –º–µ—Å—Ç–∞
- –†–∏—Å–∫ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

**–†–µ—à–µ–Ω–∏–µ**:
–í—ã–Ω–µ—Å—Ç–∏ –≤ –æ–±—â—É—é —É—Ç–∏–ª–∏—Ç—É:
```typescript
// src/entities/map-point/lib/getIconForPoint.ts
export function getIconForPoint(point: MapPoint, size: 'sm' | 'md' = 'md'): React.ReactNode {
  const iconClass = size === 'sm' ? 'w-4 h-4' : 'w-5 h-5'
  // ... –æ–±—â–∞—è –ª–æ–≥–∏–∫–∞
}
```

---

### 5. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è XP

**–ü—Ä–æ–±–ª–µ–º–∞**: –ò–¥–µ–Ω—Ç–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –æ–ø—ã—Ç–∞ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ –¥–≤—É—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö.

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**:
- `convex/mapPoints.ts:322-328` - –≤ `markResearched`
- `convex/mapPoints.ts:607-610` - –≤ `activateByQR`

**–î–µ—Ç–∞–ª–∏**:
```typescript
// markResearched:322-328
const rawDanger = (point.metadata as PointMetadata | undefined)?.danger_level
type DangerLevel = 'low' | 'medium' | 'high'
const danger: DangerLevel = (rawDanger === 'low' || rawDanger === 'medium' || rawDanger === 'high') ? rawDanger : 'low'
const xpGain = danger === 'medium' ? 75 : danger === 'high' ? 125 : 50

// activateByQR:607-610 - –¢–û–ß–ù–û –¢–ê–ö–ê–Ø –ñ–ï –õ–û–ì–ò–ö–ê
const rawDanger = (point.metadata as PointMetadata | undefined)?.danger_level
type DangerLevel = 'low' | 'medium' | 'high'
const danger: DangerLevel = (rawDanger === 'low' || rawDanger === 'medium' || rawDanger === 'high') ? rawDanger : 'low'
const xpGain = danger === 'medium' ? 75 : danger === 'high' ? 125 : 50
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è**:
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ ~10 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞
- –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–æ—Ä–º—É–ª—ã XP –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å –¥–≤–∞ –º–µ—Å—Ç–∞
- –†–∏—Å–∫ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

**–†–µ—à–µ–Ω–∏–µ**:
–í—ã–Ω–µ—Å—Ç–∏ –≤ –æ–±—â—É—é —Ñ—É–Ω–∫—Ü–∏—é:
```typescript
// convex/mapPoints.ts
function calculateXPForPoint(point: Doc<'map_points'>): number {
  const rawDanger = (point.metadata as PointMetadata | undefined)?.danger_level
  type DangerLevel = 'low' | 'medium' | 'high'
  const danger: DangerLevel = (rawDanger === 'low' || rawDanger === 'medium' || rawDanger === 'high') ? rawDanger : 'low'
  return danger === 'medium' ? 75 : danger === 'high' ? 125 : 50
}
```

---

### 6. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–æ—ë–≤ –∑–æ–Ω

**–ü—Ä–æ–±–ª–µ–º–∞**: –ò–¥–µ–Ω—Ç–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–æ—ë–≤ Mapbox –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ –¥–≤—É—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö.

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**:
- `src/widgets/map/map-view/FactionZonesLayer.tsx:31-95`
- `src/widgets/map/map-view/DangerZonesLayer.tsx:19-61`

**–î–µ—Ç–∞–ª–∏**:
–û–±–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –∏–º–µ—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É:
1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è source
2. –°–æ–∑–¥–∞–Ω–∏–µ source —Å –ø—É—Å—Ç—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
3. –°–æ–∑–¥–∞–Ω–∏–µ fill layer
4. –°–æ–∑–¥–∞–Ω–∏–µ line layer
5. Cleanup –ø—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
6. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏
7. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è**:
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ ~60 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞
- –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª–æ–≥–∏–∫–∏ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å –¥–≤–∞ –º–µ—Å—Ç–∞
- –†–∏—Å–∫ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

**–†–µ—à–µ–Ω–∏–µ**:
–°–æ–∑–¥–∞—Ç—å –æ–±—â–∏–π —Ö—É–∫ –∏–ª–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç:
```typescript
// src/widgets/map/map-view/useZoneLayer.ts
export function useZoneLayer(
  map: Map | null,
  sourceId: string,
  fillLayerId: string,
  lineLayerId: string,
  zones: Zone[],
  visible: boolean,
  getFillColor: (zone: Zone) => string,
  getLineColor: (zone: Zone) => string
) {
  // –û–±—â–∞—è –ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ª–æ—ë–≤
}
```

---

### 7. –ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å: pointId vs pointKey

**–ü—Ä–æ–±–ª–µ–º–∞**: –í —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ä–∞–∑–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ —Ç–æ—á–∫–∏.

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**:
- `convex/mapPoints.ts:268` - `pointKey: v.string()` –≤ `markResearched`
- `convex/mapPoints.ts:508` - `pointId: v.string()` –≤ `addTestQRCode`
- `convex/mapPoints.ts:549` - –Ω–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –≤ `activateByQR`, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `point.id`
- `src/pages/MapPage.tsx:130` - `pointId: qrTargetPoint._id`

**–î–µ—Ç–∞–ª–∏**:
- –í —Å—Ö–µ–º–µ –ë–î –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ–ª–µ `id` (—Å—Ç—Ä–æ–∫–∞)
- –í `point_discoveries` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `pointKey` (—Å—Ç—Ä–æ–∫–∞)
- –í –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `pointId`
- –í –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –º–µ—Å—Ç–∞—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `_id` (Convex ID)

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è**:
- –ü—É—Ç–∞–Ω–∏—Ü–∞ –ø—Ä–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏ –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ç–∏–ø–∞ ID
- –ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å API

**–†–µ—à–µ–Ω–∏–µ**:
–£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
- –í –ë–î: `id` (—Å—Ç—Ä–æ–∫–∞) - —ç—Ç–æ `pointKey`
- –í API: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `pointKey` –≤–µ–∑–¥–µ
- –ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `_id` –¥–ª—è —Ç–æ—á–µ–∫ –∫–∞—Ä—Ç—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –∑–∞–ø–∏—Å–µ–π Convex)

---

## üü¢ –ú–ï–ù–ï–ï –ö–†–ò–¢–ò–ß–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### 8. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞**: –§—É–Ω–∫—Ü–∏—è `calculateDistance` —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö.

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**:
- `convex/mapPoints.ts:35-47` - —Ñ—É–Ω–∫—Ü–∏—è `calculateDistance`
- `src/shared/hooks/useMapData.ts:300-319` - —Ñ—É–Ω–∫—Ü–∏—è `calculateDistance`

**–î–µ—Ç–∞–ª–∏**:
–û–±–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ñ–æ—Ä–º—É–ª—É Haversine –∏ –∏–¥–µ–Ω—Ç–∏—á–Ω—É—é –ª–æ–≥–∏–∫—É.

**–†–µ—à–µ–Ω–∏–µ**:
–í—ã–Ω–µ—Å—Ç–∏ –≤ –æ–±—â—É—é —É—Ç–∏–ª–∏—Ç—É –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, `geolib`).

---

### 9. –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π —Ö—É–∫ useSafeZones

**–ü—Ä–æ–±–ª–µ–º–∞**: –•—É–∫ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è, –Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è.

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `src/widgets/map/map-view/MapView.tsx:117-120`

```typescript
const { isLoading: isZonesLoading } = useSafeZones({
  bbox,
  enabled: showSafeZones,
})
// zones –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è!
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è**:
- –õ–∏—à–Ω–∏–π –∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É
- –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∫–æ–¥

**–†–µ—à–µ–Ω–∏–µ**:
–£–¥–∞–ª–∏—Ç—å –≤—ã–∑–æ–≤ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ `FactionZonesLayer`.

---

### 10. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤ —Ñ—Ä–∞–∫—Ü–∏–π

**–ü—Ä–æ–±–ª–µ–º–∞**: –¶–≤–µ—Ç–∞ —Ñ—Ä–∞–∫—Ü–∏–π –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö.

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**:
- `src/entities/map-point/ui/MapPointMarker.tsx:110-127` - —Ü–≤–µ—Ç–∞ –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤
- `src/entities/map-point/ui/MapPointPopup.tsx:164-183` - –≥—Ä–∞–¥–∏–µ–Ω—Ç—ã –¥–ª—è –ø–æ–ø–∞–ø–æ–≤
- `src/widgets/map/map-view/FactionZonesLayer.tsx:52-59` - —Ü–≤–µ—Ç–∞ –¥–ª—è —Å–ª–æ—ë–≤

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è**:
- –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ü–≤–µ—Ç–æ–≤–æ–π —Å—Ö–µ–º—ã –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å —Ç—Ä–∏ –º–µ—Å—Ç–∞
- –†–∏—Å–∫ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

**–†–µ—à–µ–Ω–∏–µ**:
–°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã —Ü–≤–µ—Ç–æ–≤ —Ñ—Ä–∞–∫—Ü–∏–π:
```typescript
// src/shared/constants/factionColors.ts
export const FACTION_COLORS = {
  fjr: { border: 'blue-800', bg: 'blue-900/20', text: 'blue-400' },
  // ...
}
```

---

## üìä –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–±–ª–µ–º

| # | –ü—Ä–æ–±–ª–µ–º–∞ | –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å | –¢–∏–ø | –§–∞–π–ª—ã |
|---|----------|-------------|-----|-------|
| 1 | –ö–æ–Ω—Ñ–ª–∏–∫—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω—ã–º–∏ –∑–æ–Ω–∞–º–∏ | üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ | –ö–æ–Ω—Ñ–ª–∏–∫—Ç | SafeZonesControl.ts, FactionZonesLayer.tsx, MapView.tsx |
| 2 | –ë–∞–≥: –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –≤ handleQRScan | üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ | –ë–∞–≥ | MapPage.tsx, mapPoints.ts |
| 3 | –ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–π selectedPoint vs selectedPointId | üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ | –ö–æ–Ω—Ñ–ª–∏–∫—Ç | MapPage.tsx, MapView.tsx |
| 4 | –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ getIconForPoint | üü° –í–∞–∂–Ω–æ | –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ | MapPointMarker.tsx, MapPointPopup.tsx |
| 5 | –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è XP | üü° –í–∞–∂–Ω–æ | –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ | mapPoints.ts (2 –º–µ—Å—Ç–∞) |
| 6 | –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–æ—ë–≤ | üü° –í–∞–∂–Ω–æ | –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ | FactionZonesLayer.tsx, DangerZonesLayer.tsx |
| 7 | –ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å pointId vs pointKey | üü° –í–∞–∂–Ω–æ | –ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å | mapPoints.ts, MapPage.tsx |
| 8 | –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ calculateDistance | üü¢ –ú–µ–Ω–µ–µ –∫—Ä–∏—Ç–∏—á–Ω–æ | –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ | mapPoints.ts, useMapData.ts |
| 9 | –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π —Ö—É–∫ useSafeZones | üü¢ –ú–µ–Ω–µ–µ –∫—Ä–∏—Ç–∏—á–Ω–æ | –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∫–æ–¥ | MapView.tsx |
| 10 | –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤ —Ñ—Ä–∞–∫—Ü–∏–π | üü¢ –ú–µ–Ω–µ–µ –∫—Ä–∏—Ç–∏—á–Ω–æ | –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ | MapPointMarker.tsx, MapPointPopup.tsx, FactionZonesLayer.tsx |

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–∏—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ):
1. **–ö–æ–Ω—Ñ–ª–∏–∫—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω—ã–º–∏ –∑–æ–Ω–∞–º–∏** - –º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ
2. **–ë–∞–≥ —Å pointId –≤ handleQRScan** - –º–æ–∂–µ—Ç –ª–æ–º–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å QR-—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
3. **–ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–π selectedPoint** - –º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é UI

### –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–∏—Å–ø—Ä–∞–≤–∏—Ç—å –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è):
4. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ getIconForPoint** - —É–ø—Ä–æ—Å—Ç–∏—Ç –ø–æ–¥–¥–µ—Ä–∂–∫—É
5. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è XP** - —É–ø—Ä–æ—Å—Ç–∏—Ç –ø–æ–¥–¥–µ—Ä–∂–∫—É
6. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–æ—ë–≤** - —É–ø—Ä–æ—Å—Ç–∏—Ç –ø–æ–¥–¥–µ—Ä–∂–∫—É
7. **–ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å pointId vs pointKey** - —É–ª—É—á—à–∏—Ç –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å API

### –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–º–æ–∂–Ω–æ –æ—Ç–ª–æ–∂–∏—Ç—å):
8. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ calculateDistance** - –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –Ω–æ —É–ª—É—á—à–∏—Ç –∫–æ–¥
9. **–ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π —Ö—É–∫ useSafeZones** - –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
10. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤ —Ñ—Ä–∞–∫—Ü–∏–π** - —É–ª—É—á—à–∏—Ç –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∏–∑–∞–π–Ω–∞

---

## üîß –ë—ã—Å—Ç—Ä—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #1: –£–¥–∞–ª–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π SafeZonesControl
```typescript
// MapView.tsx - —É–¥–∞–ª–∏—Ç—å –∏–º–ø–æ—Ä—Ç –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ SafeZonesControl
// –û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ FactionZonesLayer
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #2: –ò—Å–ø—Ä–∞–≤–∏—Ç—å handleQRScan
```typescript
// MapPage.tsx:129
const result = await activateByQR({
  // –£–¥–∞–ª–∏—Ç—å pointId
  qrCode: data,
  deviceId
})
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #3: –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å selectedPoint
```typescript
// MapPage.tsx - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ selectedPointId
const [selectedPointId, setSelectedPointId] = useState<string | null>(null)
// –ù–∞—Ö–æ–¥–∏—Ç—å —Ç–æ—á–∫—É –ø–æ ID –∏–∑ –º–∞—Å—Å–∏–≤–∞ points
const selectedPoint = points.find(p => p.id === selectedPointId)
```

---

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ **10 –ø—Ä–æ–±–ª–µ–º**, –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö:
- üî¥ **3 –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö** (–∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∏ –±–∞–≥–∏)
- üü° **4 –≤–∞–∂–Ω—ã—Ö** (–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –Ω–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏)
- üü¢ **3 –º–µ–Ω–µ–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö** (—É–ª—É—á—à–µ–Ω–∏—è –∫–æ–¥–∞)

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–∞—á–∞—Ç—å —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º, –æ—Å–æ–±–µ–Ω–Ω–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω—ã–º–∏ –∑–æ–Ω–∞–º–∏, —Ç–∞–∫ –∫–∞–∫ –æ–Ω –º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ –∫–∞—Ä—Ç—ã.

