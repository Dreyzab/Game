# Конфликты и баги карты (кратко)

> Backend: Bun + Elysia (`server/src/api/routes/map.ts`). Детали и контекст: `MAP_GUIDE.md`.

## Критичное
- Безопасные зоны: два механизма (`SafeZonesControl` vs `FactionZonesLayer`) и двойные запросы `useSafeZones`. Решение: оставить единый слой, удалить/объединить контрол.
- QR активация: фронт передает `pointId/_id`, сервер ждёт только `qrCode`. Решение: не отправлять `pointId`, унифицировать ID.
- Выбор точки: `selectedPoint` (страница) vs `selectedPointId` (MapView) рассинхронизированы. Решение: единый источник истины `selectedPointId`.

## Важно
- Дублирование `getIconForPoint` (Marker/Popup) — вынести в утилиту.
- XP по `danger_level` дублируется — общая функция.
- Слои зон (safe/danger) повторяют одну логику — общий хук/фабрика.
- pointId/pointKey/_id перемешаны — единый формат `id/pointKey`.

## Меньше критично
- Дублирование `calculateDistance` (server/client) — вынести в shared.
- Неиспользуемый `useSafeZones` вызов в `MapView` — убрать или передавать в слой.
- Цвета фракций определены в нескольких местах — вынести в константы.

## Очередность действий
1) Убрать двойное управление safe zones и лишний запрос.  
2) Починить QR (убрать `pointId`).  
3) Свести выбор точки к `selectedPointId`.  
4) Разнести общие утилиты (иконки, XP, зоны).  

Подробнее о потоках данных, архитектуре и API: `MAP_GUIDE.md`.

